# Nginx Reverse Proxy Configuration for Keycloak + Push MFA Mock Simulator
# 
# This configuration allows both Keycloak and the mock simulator to be accessed
# from the same host and port (https://myapp.local), eliminating CORS issues.
#
# Setup:
# 1. Add to /etc/hosts: 127.0.0.1 myapp.local
# 2. Prepare SSL certs at /mnt/c/certs/myapp/
# 3. Run: docker run -p 80:80 -p 443:443 --add-host=host.docker.internal:host-gateway \
#         -v $(pwd)/nginx.conf:/etc/nginx/conf.d/default.conf:ro \
#         -v /mnt/c/certs/myapp:/etc/nginx/certs:ro nginx:alpine

# HTTP Server - Redirect all HTTP traffic to HTTPS
server {
  listen 80;
  server_name myapp.local;
  
  # Force HTTPS for all requests
  return 301 https://$host$request_uri;
}

# HTTPS Server - Main configuration
server {
  listen 443 ssl;
  server_name myapp.local;

  # SSL Configuration
  ssl_certificate     /etc/nginx/certs/myapp.local.pem;
  ssl_certificate_key /etc/nginx/certs/myapp.local-key.pem;

  # Optional SSL optimization
  ssl_session_cache shared:SSL:10m;
  ssl_session_timeout 10m;

  # ========== MOCK SIMULATOR PROXY ==========
  # Routes requests to /mock to the Spring Boot mock simulator
  # Backend: http://host.docker.internal:5000/mock/
  location /mock {
    proxy_pass http://host.docker.internal:5000/mock/;
    proxy_http_version 1.1;
    
    # Forward original client information
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    
    # Indicate the original request path prefix
    proxy_set_header X-Forwarded-Prefix /mock;
  }

  # Handle /mock without trailing slash - redirect to /mock/
  # This ensures clean URL handling for browsers and scripts
  location = /mock {
    return 301 /mock/;
  }

  # ========== KEYCLOAK PROXY ==========
  # Routes all other requests to Keycloak
  # Backend: http://host.docker.internal:8080
  # This catches /realms, /auth, /admin, etc.
  location / {
    proxy_pass http://host.docker.internal:8080;
    proxy_http_version 1.1;

    # Forward original client information
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    
    # Important: Tell Keycloak the original scheme was HTTPS
    # This ensures Keycloak generates correct redirect URLs and CORS headers
    proxy_set_header X-Forwarded-Proto https;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Host $host;
    proxy_set_header X-Forwarded-Port 443;
  }
}
